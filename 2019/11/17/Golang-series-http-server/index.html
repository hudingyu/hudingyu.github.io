<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Go基础系列：深入理解 http server - Turling的博客 | Turling Blog
        
    </title>

    <link rel="canonical" href="https://turling.me/2019/11/17/Golang-series-http-server/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- ga & ba script hoook -->
    <script></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.11.0/js/md5.min.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Turling Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://turling.me/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('polar-lights.jpeg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Golang" title="Golang">Golang</a>
                        
                    </div>
                    <h1>Go基础系列：深入理解 http server</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Turling on
                        2019-11-17
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <div class="output_wrapper" id="output_wrapper_id" style="font-size: 15px; color: rgb(62, 62, 62); line-height: 1.8; word-spacing: 2px; letter-spacing: 2px; font-family: 'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; background-size: 20px 20px; background-position: center center;"><h3 id="h" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">前言</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">对于Golang来说，实现一个简单的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>非常容易，只需要短短几行代码。同时有了协程的加持，Go实现的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>能够取得非常优秀的性能。这篇文章将会对go标准库<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">net/http</code>实现http服务的原理进行较为深入的探究，以此来学习了解网络编程的常见范式以及设计思路。</p><br><h3 id="hhttp" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">HTTP服务</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">基于HTTP构建的网络应用包括两个端，即客户端(<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Client</code>)和服务端(<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>)。两个端的交互行为包括从客户端发出<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>、服务端接受<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>进行处理并返回<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>以及客户端处理<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>。所以http服务器的工作就在于如何接受来自客户端的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>，并向客户端返回<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">典型的http服务端的处理流程可以用下图表示：</p><br><img src="http-server.png" alt><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">服务器在接收到请求时，首先会进入路由(<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">router</code>)，这是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Multiplexer</code>，路由的工作在于为这个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>找到对应的处理器(<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>)，处理器对<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>进行处理，并构建<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>。Golang实现的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>同样遵循这样的处理流程。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">我们先看看Golang如何实现一个简单的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">package</span>&nbsp;main<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;(&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“fmt”</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“net/http”</span>)<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">indexHandler</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;http.ResponseWriter,&nbsp;r&nbsp;<em>http.Request)</em></span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintf(w,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“hello&nbsp;world”</span>)}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">main</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">()</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“/“</span>,&nbsp;indexHandler)&nbsp;&nbsp;&nbsp;&nbsp;http.ListenAndServe(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“:8000”</span>,&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">运行代码之后，在浏览器中打开<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">localhost:8000</code>就可以看到<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">hello world</code>。这段代码先利用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.HandleFunc</code>在根路由<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">/</code>上注册了一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">indexHandler</code>, 然后利用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.ListenAndServe</code>开启监听。当有请求过来时，则根据路由执行对应的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>函数。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">我们再来看一下另外一种常见的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>实现方式：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">package</span>&nbsp;main<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;(&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“fmt”</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“net/http”</span>)<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;indexHandler&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(ih&nbsp;indexHandler)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;http.ResponseWriter,&nbsp;r&nbsp;<em>http.Request)</em></span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintf(w,&nbsp;ih.content)}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">main</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">()</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“/“</span>,&nbsp;&amp;indexHandler{content:&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“hello&nbsp;world!”</span>})&nbsp;&nbsp;&nbsp;&nbsp;http.ListenAndServe(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“:8001”</span>,&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">Go实现的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http</code>服务步骤非常简单，首先注册路由，然后创建服务并开启监听即可。下文我们将从注册路由、开启服务、处理请求这几个步骤了解Golang如何实现<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http</code>服务。</p><br><h3 id="h-1" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">注册路由</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.HandleFunc</code>和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.Handle</code>都是用于注册路由，可以发现两者的区别在于第二个参数，前者是一个具有<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">func(w http.ResponseWriter, r http.Requests)</code>签名的函数，而后者是一个结构体，该结构体实现了<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">func(w http.ResponseWriter, r <em>http.Requests)</em></code>签名的方法。<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.HandleFunc</code>和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.Handle</code>的源码如下：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">HandleFunc</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>,&nbsp;handler&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>(ResponseWriter,&nbsp;Request)</span>)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;DefaultServeMux.HandleFunc(pattern,&nbsp;handler)}<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;<em>ServeMux)</em></span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">HandleFunc</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>,&nbsp;handler&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>(ResponseWriter,&nbsp;Request)</span>)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;handler&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">panic</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“http:&nbsp;nil&nbsp;handler”</span>)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;mux.Handle(pattern,&nbsp;HandlerFunc(handler))}</code></pre><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Handle</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>,&nbsp;handler&nbsp;Handler)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DefaultServeMux.Handle(pattern,&nbsp;handler)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">可以看到这两个函数最终都由<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">DefaultServeMux</code>调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handle</code>方法来完成路由的注册。这里我们遇到两种类型的对象：<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>，我们先说<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>。</p><br><h5 id="hhandler" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; font-size: 1em;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">Handler</span></h5><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>是一个接口：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;Handler&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">interface</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;ServeHTTP(ResponseWriter,&nbsp;<em>Request)}</em></code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>接口中声明了名为<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>的函数签名，也就是说任何结构只要实现了这个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法，那么这个结构体就是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象。其实go的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http</code>服务都是基于<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>进行处理，而<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法也正是用以处理<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>并构建<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>的核心逻辑所在。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">回到上面的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">HandleFunc</code>函数，注意一下这行代码：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">mux.Handle(pattern,&nbsp;HandlerFunc(handler))</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">可能有人认为<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">HandlerFunc</code>是一个函数，包装了传入的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>函数，返回了一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象。然而这里<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">HandlerFunc</code>实际上是将<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>函数做了一个<strong style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold; color: rgb(255, 80, 44);">类型转换</strong>，看一下<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">HandlerFunc</code>的定义：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;HandlerFunc&nbsp;<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(ResponseWriter,&nbsp;Request)</span>//&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">calls</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">f</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w,&nbsp;r)</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(f&nbsp;HandlerFunc)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;ResponseWriter,&nbsp;r&nbsp;<em>Request)</em></span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;f(w,&nbsp;r)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">HandlerFunc</code>是一个类型，只不过表示的是一个具有<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">func(ResponseWriter, Request)</code>签名的函数类型，并且这种类型实现了<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法（在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法中又调用了自身），也就是说这个类型的函数其实就是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>类型的对象。利用这种类型转换，我们可以将一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>函数转换为一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象，而不需要定义一个结构体，再让这个结构实现<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法。读者可以体会一下这种技巧。</p><br><h5 id="hservemux" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; font-size: 1em;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">ServeMux</span></h5><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">Golang中的路由（即<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Multiplexer</code>）基于<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>结构，先看一下<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的定义：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;ServeMux&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;mu&nbsp;&nbsp;&nbsp;&nbsp;sync.RWMutex&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">map</span>[<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>]muxEntry&nbsp;&nbsp;&nbsp;&nbsp;es&nbsp;&nbsp;&nbsp;&nbsp;[]muxEntry&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;slice&nbsp;of&nbsp;entries&nbsp;sorted&nbsp;from&nbsp;longest&nbsp;to&nbsp;shortest.</span>&nbsp;&nbsp;&nbsp;&nbsp;hosts&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span>}<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;muxEntry&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;&nbsp;&nbsp;&nbsp;pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">这里重点关注<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>中的字段<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">m</code>，这是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">map</code>，<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">key</code>是路由表达式，<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">value</code>是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">muxEntry</code>结构，<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">muxEntry</code>结构体存储了对应的路由表达式和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">值得注意的是，<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>也实现了<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;<em>ServeMux)</em></span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;ResponseWriter,&nbsp;r&nbsp;Request)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;r.RequestURI&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“<em>“</em></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;r.ProtoAtLeast(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">1</span>,&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">1</span>)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“Connection”</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“close”</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.WriteHeader(StatusBadRequest)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;h,&nbsp;_&nbsp;:=&nbsp;mux.Handler(r)&nbsp;&nbsp;&nbsp;&nbsp;h.ServeHTTP(w,&nbsp;r)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">也就是说<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>结构体也是<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象，只不过<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法不是用来处理具体的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">request</code>和构建<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">response</code>，而是用来确定路由注册的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>。</p><br><h5 id="h-2" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; font-size: 1em;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">注册路由</span></h5><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">搞明白<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>之后，我们再回到之前的代码：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">DefaultServeMux.Handle(pattern,&nbsp;handler)</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">这里的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">DefaultServeMux</code>表示一个默认的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Multiplexer</code>，当我们没有创建自定义的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Multiplexer</code>，则会自动使用一个默认的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Multiplexer</code>。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">然后再看一下<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handle</code>方法具体做了什么：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;ServeMux)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Handle</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>,&nbsp;handler&nbsp;Handler)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;mux.mu.Lock()&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">defer</span>&nbsp;mux.mu.Unlock()&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;pattern&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“”</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">panic</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“http:&nbsp;invalid&nbsp;pattern”</span>)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;handler&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">panic</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“http:&nbsp;nil&nbsp;handler”</span>)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;_,&nbsp;exist&nbsp;:=&nbsp;mux.m[pattern];&nbsp;exist&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">panic</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;”</span>&nbsp;+&nbsp;pattern)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;mux.m&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mux.m&nbsp;=&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">make</span>(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">map</span>[<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>]muxEntry)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;利用当前的路由和handler创建muxEntry对象</span>&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;:=&nbsp;muxEntry{h:&nbsp;handler,&nbsp;pattern:&nbsp;pattern}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;向ServeMux的map[string]muxEntry增加新的路由匹配规则</span>&nbsp;&nbsp;&nbsp;&nbsp;mux.m[pattern]&nbsp;=&nbsp;e&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;如果路由表达式以’/‘结尾，则将对应的muxEntry对象加入到[]muxEntry中，按照路由表达式长度排序</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;pattern[<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(230, 192, 123); word-wrap: inherit !important; word-break: inherit !important;">len</span>(pattern)<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">-1</span>]&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">‘/‘</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mux.es&nbsp;=&nbsp;appendSorted(mux.es,&nbsp;e)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;pattern[<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">0</span>]&nbsp;!=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">‘/‘</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mux.hosts&nbsp;=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">true</span>&nbsp;&nbsp;&nbsp;&nbsp;}}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handle</code>方法主要做了两件事情：一个就是向<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">map[string]muxEntry</code>增加给定的路由匹配规则；然后如果路由表达式以<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">‘/‘</code>结尾，则将对应的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">muxEntry</code>对象加入到<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">[]muxEntry</code>中，按照路由表达式长度排序。前者很好理解，但后者可能不太容易看出来有什么作用，这个问题后面再作分析。</p><br><h5 id="hservemux-1" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; font-size: 1em;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">自定义ServeMux</span></h5><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">我们也可以创建自定义的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>取代默认的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">DefaultServeMux</code>：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">package</span>&nbsp;main<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;(&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“fmt”</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“net/http”</span>)<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">indexHandler</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;http.ResponseWriter,&nbsp;r&nbsp;<em>http.Request)</em></span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintf(w,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“hello&nbsp;world”</span>)}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">htmlHandler</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;http.ResponseWriter,&nbsp;r&nbsp;http.Request)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“Content-Type”</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“text/html”</span>)&nbsp;&nbsp;&nbsp;&nbsp;html&nbsp;:=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;"><code>&amp;lt;!doctype&amp;nbsp;html&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;META&amp;nbsp;http-equiv=&quot;Content-Type&quot;&amp;nbsp;content=&quot;text/html&quot;&amp;nbsp;charset=&quot;utf-8&quot;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;html&amp;nbsp;lang=&quot;zh-CN&quot;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;head&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;title&amp;gt;Golang&amp;lt;/title&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;meta&amp;nbsp;name=&quot;viewport&quot;&amp;nbsp;content=&quot;width=device-width,&amp;nbsp;initial-scale=1.0,&amp;nbsp;maximum-scale=1.0,&amp;nbsp;user-scalable=0;&quot;&amp;nbsp;/&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;/head&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;body&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;div&amp;nbsp;id=&quot;app&quot;&amp;gt;Welcome!&amp;lt;/div&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;/body&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;/html&amp;gt;</code></span>&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintf(w,&nbsp;html)}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">main</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">()</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;mux&nbsp;:=&nbsp;http.NewServeMux()&nbsp;&nbsp;&nbsp;&nbsp;mux.Handle(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“/“</span>,&nbsp;http.HandlerFunc(indexHandler))&nbsp;&nbsp;&nbsp;&nbsp;mux.HandleFunc(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“/welcome”</span>,&nbsp;htmlHandler)&nbsp;&nbsp;&nbsp;&nbsp;http.ListenAndServe(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“:8001”</span>,&nbsp;mux)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">NewServeMux()</code>可以创建一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>实例，之前提到<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>也实现了<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法，因此<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">mux</code>也是一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象。对于<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ListenAndServe()</code>方法，如果传入的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>参数是自定义<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>实例<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">mux</code>，那么<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>实例接收到的路由对象将不再是<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">DefaultServeMux</code>而是<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">mux</code>。</p><br><h3 id="h-3" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">开启服务</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">首先从<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.ListenAndServe</code>这个方法开始：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ListenAndServe</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(addr&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>,&nbsp;handler&nbsp;Handler)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">error</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;:=&nbsp;&amp;Server{Addr:&nbsp;addr,&nbsp;Handler:&nbsp;handler}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;server.ListenAndServe()}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(srv&nbsp;<em>Server)</em></span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ListenAndServe</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">()</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">error</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;srv.shuttingDown()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;ErrServerClosed&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;addr&nbsp;:=&nbsp;srv.Addr&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;addr&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“”</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addr&nbsp;=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“:http”</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;ln,&nbsp;err&nbsp;:=&nbsp;net.Listen(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“tcp”</span>,&nbsp;addr)&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;err&nbsp;!=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;err&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;srv.Serve(tcpKeepAliveListener{ln.(net.TCPListener)})}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">这里先创建了一个<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>对象，传入了地址和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>参数，然后调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>对象<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ListenAndServe()</code>方法。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">看一下<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>这个结构体，<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>结构体中字段比较多，可以先大致了解一下：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;Server&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;”:http”&nbsp;if&nbsp;empty</span>&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;Handler&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span>&nbsp;&nbsp;&nbsp;&nbsp;TLSConfig&nbsp;<em>tls.Config&nbsp;&nbsp;&nbsp;&nbsp;ReadTimeout&nbsp;time.Duration&nbsp;&nbsp;&nbsp;&nbsp;ReadHeaderTimeout&nbsp;time.Duration&nbsp;&nbsp;&nbsp;&nbsp;WriteTimeout&nbsp;time.Duration&nbsp;&nbsp;&nbsp;&nbsp;IdleTimeout&nbsp;time.Duration&nbsp;&nbsp;&nbsp;&nbsp;MaxHeaderBytes&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">int</span>&nbsp;&nbsp;&nbsp;&nbsp;TLSNextProto&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">map</span>[<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>]<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(</span></span></em>Server,&nbsp;<em>tls.Conn,&nbsp;Handler)&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ConnState</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">func</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(net.Conn,&nbsp;ConnState)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ErrorLog</span>&nbsp;</em><span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">log</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Logger</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">disableKeepAlives</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">int32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">accessed</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">atomically</span>.&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">inShutdown</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">int32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">accessed</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">atomically</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(non-zero&nbsp;means&nbsp;we’re&nbsp;in&nbsp;Shutdown)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">nextProtoOnce</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">sync</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Once</span>&nbsp;//&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">guards</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">setupHTTP2_</span><em>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">init</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">nextProtoErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">result</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">of</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">http2</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ConfigureServer</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">used</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">sync</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">listeners</span>&nbsp;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">map</span>[</em><span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">net</span>.<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Listener</span>]<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">struct</span>{}&nbsp;&nbsp;&nbsp;&nbsp;activeConn&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">map</span>[<em>conn]<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>{}&nbsp;&nbsp;&nbsp;&nbsp;doneChan&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">chan</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>{}&nbsp;&nbsp;&nbsp;&nbsp;onShutdown&nbsp;[]<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">()</span>}</span></em></code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ListenAndServe</code>方法中，会初始化监听地址<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Addr</code>，同时调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Listen</code>方法设置监听。最后将监听的TCP对象传入<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Serve</code>方法：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(srv&nbsp;Server)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">Serve</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(l&nbsp;net.Listener)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">error</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;&nbsp;&nbsp;&nbsp;baseCtx&nbsp;:=&nbsp;context.Background()&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;base&nbsp;is&nbsp;always&nbsp;background,&nbsp;per&nbsp;Issue&nbsp;16220</span>&nbsp;&nbsp;&nbsp;&nbsp;ctx&nbsp;:=&nbsp;context.WithValue(baseCtx,&nbsp;ServerContextKey,&nbsp;srv)&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rw,&nbsp;e&nbsp;:=&nbsp;l.Accept()&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;等待新的连接建立</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;:=&nbsp;srv.newConn(rw)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.setState(c.rwc,&nbsp;StateNew)&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">go</span>&nbsp;c.serve(ctx)&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;创建新的协程处理请求</span>&nbsp;&nbsp;&nbsp;&nbsp;}}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">这里隐去了一些细节，以便了解<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Serve</code>方法的主要逻辑。首先创建一个上下文对象，然后调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Listener</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Accept()</code>等待新的连接建立；一旦有新的连接建立，则调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Server</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">newConn()</code>创建新的连接对象，并将连接的状态标志为<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">StateNew</code>，然后开启一个新的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">goroutine</code>处理连接请求。</p><br><h3 id="h-4" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">处理连接</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">我们继续探索<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">conn</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">serve()</code>方法，这个方法同样很长，我们同样只看关键逻辑。坚持一下，马上就要看见大海了。</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(c&nbsp;<em>conn)</em></span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">serve</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(ctx&nbsp;context.Context)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w,&nbsp;err&nbsp;:=&nbsp;c.readRequest(ctx)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;c.r.remain&nbsp;!=&nbsp;c.server.initialReadLimitSize()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we’re&nbsp;active.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.setState(c.rwc,&nbsp;StateActive)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can’t&nbsp;read&nbsp;another,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;[<em>]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</em></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;But&nbsp;we’re&nbsp;not&nbsp;going&nbsp;to&nbsp;implement&nbsp;HTTP&nbsp;pipelining&nbsp;because&nbsp;it</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;was&nbsp;never&nbsp;deployed&nbsp;in&nbsp;the&nbsp;wild&nbsp;and&nbsp;the&nbsp;answer&nbsp;is&nbsp;HTTP/2.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverHandler{c.server}.ServeHTTP(w,&nbsp;w.req)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.cancelCtx()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;c.hijacked()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.finishRequest()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;!w.shouldReuseConnection()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;w.requestBodyLimitHit&nbsp;||&nbsp;w.closedRequestBodyEarly()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.closeWriteAndWait()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.setState(c.rwc,&nbsp;StateIdle)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.curReq.Store((response)(<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;&nbsp;&nbsp;&nbsp;}}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">当一个连接建立之后，该连接中所有的请求都将在这个协程中进行处理，直到连接被关闭。在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">serve()</code>方法中会循环调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">readRequest()</code>方法读取下一个请求进行处理，其中最关键的逻辑就是一行代码：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">serverHandler{c.server}.ServeHTTP(w,&nbsp;w.req)</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">进一步解释<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">serverHandler</code>：</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">type</span>&nbsp;serverHandler&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">struct</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;srv&nbsp;<em>Server}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(sh&nbsp;serverHandler)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(rw&nbsp;ResponseWriter,&nbsp;req&nbsp;</span></span></em>Request)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;handler&nbsp;:=&nbsp;sh.srv.Handler&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;handler&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler&nbsp;=&nbsp;DefaultServeMux&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;req.RequestURI&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“<em>“</em></span>&nbsp;&amp;&amp;&nbsp;req.Method&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“OPTIONS”</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler&nbsp;=&nbsp;globalOptionsHandler{}&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;handler.ServeHTTP(rw,&nbsp;req)}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">serverHandler</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP()</code>方法里的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">sh.srv.Handler</code>其实就是我们最初在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http.ListenAndServe()</code>中传入的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象，也就是我们自定义的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>对象。如果该<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象为<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">nil</code>，则会使用默认的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">DefaultServeMux</code>。最后调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP()</code>方法匹配当前路由对应的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>方法。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">后面的逻辑就相对简单清晰了，主要在于调用<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">match</code>方法匹配到对应的已注册的路由表达式和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">handler</code>。</p><br><pre style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><code class="Go language-Go hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; overflow-x: auto; padding: 0.5em; color: rgb(171, 178, 191); background: rgb(40, 44, 52); white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;ServeMux)</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">ServeHTTP</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(w&nbsp;ResponseWriter,&nbsp;r&nbsp;<em>Request)</em></span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;r.RequestURI&nbsp;==&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">““</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;r.ProtoAtLeast(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">1</span>,&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(209, 154, 102); word-wrap: inherit !important; word-break: inherit !important;">1</span>)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“Connection”</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“close”</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.WriteHeader(StatusBadRequest)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;h,&nbsp;<em>&nbsp;:=&nbsp;mux.Handler(r)&nbsp;&nbsp;&nbsp;&nbsp;h.ServeHTTP(w,&nbsp;r)}<span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;<em>ServeMux)</em></span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">handler</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(host,&nbsp;path&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>)</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(h&nbsp;Handler,&nbsp;pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>)</span></span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;mux.mu.RLock()&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">defer</span>&nbsp;mux.mu.RUnlock()&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;mux.hosts&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h,&nbsp;pattern&nbsp;=&nbsp;mux.match(host&nbsp;+&nbsp;path)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;h&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h,&nbsp;pattern&nbsp;=&nbsp;mux.match(path)&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;h&nbsp;==&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h,&nbsp;pattern&nbsp;=&nbsp;NotFoundHandler(),&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“”</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>}<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string.</span><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins.</span><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">func</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(mux&nbsp;</span></span></em>ServeMux)&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(97, 174, 238); word-wrap: inherit !important; word-break: inherit !important;">match</span><span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(path&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>)</span>&nbsp;<span class="hljs-params" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;">(h&nbsp;Handler,&nbsp;pattern&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">string</span>)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Check&nbsp;for&nbsp;exact&nbsp;match&nbsp;first.</span>&nbsp;&nbsp;&nbsp;&nbsp;v,&nbsp;ok&nbsp;:=&nbsp;mux.m[path]&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;ok&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;v.h,&nbsp;v.pattern&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;Check&nbsp;for&nbsp;longest&nbsp;valid&nbsp;match.&nbsp;&nbsp;mux.es&nbsp;contains&nbsp;all&nbsp;patterns</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(92, 99, 112); font-style: italic; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;that&nbsp;end&nbsp;in&nbsp;/&nbsp;sorted&nbsp;from&nbsp;longest&nbsp;to&nbsp;shortest.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;,&nbsp;e&nbsp;:=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">range</span>&nbsp;mux.es&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;strings.HasPrefix(path,&nbsp;e.pattern)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;e.h,&nbsp;e.pattern&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(198, 120, 221); word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(86, 182, 194); word-wrap: inherit !important; word-break: inherit !important;">nil</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: rgb(152, 195, 121); word-wrap: inherit !important; word-break: inherit !important;">“”</span>}</code></pre><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">match</code>方法里我们看到之前提到的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">map[string]muxEntry</code>和<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">[]muxEntry</code>。这个方法里首先会利用进行精确匹配，在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">map[string]muxEntry</code>中查找是否有对应的路由规则存在；如果没有匹配的路由规则，则会进行近似匹配。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">对于类似<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">/path1/path2/path3</code>这样的路由，如果不能找到精确匹配的路由规则，那么则会去匹配和当前路由最接近的已注册的父路由，所以如果路由<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">/path1/path2/</code>已注册，那么该路由会被匹配，否则继续匹配父路由，知道根路由<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">/</code>。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">由于<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">[]muxEntry</code>中的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">muxEntry</code>按照路由表达是从长到短排序，所以进行近似匹配时匹配到的路由一定是已注册父路由中最接近的。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">至此，Go实现的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>的大致原理介绍完毕！</p><br><h3 id="h-5" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">总结</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">Golang通过<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeMux</code>定义了一个多路器来管理路由，并通过<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>接口定义了路由处理函数的统一规范，即<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>都须实现<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">ServeHTTP</code>方法；同时<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>接口提供了强大的扩展性，方便开发者通过<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>接口实现各种中间件。相信大家阅读下来也能感受到<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">Handler</code>对象在<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">server</code>服务的实现中真的无处不在。理解了<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">server</code>实现的基本原理，大家就可以在此基础上阅读一些第三方的<code style="font-size: inherit; line-height: inherit; overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(255, 80, 44); background: rgb(248, 248, 248);">http server</code>框架，以及编写特定功能的中间件。</p><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;">以上。</p><br><h3 id="h-6" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: rgb(239, 112, 96); color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">参考资料</span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid rgb(239, 235, 233); border-right: 20px solid transparent;"> </span></h3><br><p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.7em 0px;"><a href="https://studygolang.com/pkgdoc" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: rgb(30, 107, 184); overflow-wrap: break-word;" target="_blank" rel="noopener">【Golang标准库文档–net/http】</a></p></div>


                <hr>

                

                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/2019/10/13/Golang-series-interface-and-reflect/" data-toggle="tooltip" data-placement="top" title="Go基础系列：深入理解 interface和reflect">Next Post &rarr;</a>
                        </li>
                    
                </ul>
                <div id="gitalk-container"></div>
                

                

            </div>

            
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/hudingyu">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Turling Blog 2019 
                    <!-- <br> -->
                    <!-- Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> |  -->
                    <!-- <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe> -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://turling.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<script type="text/javascript">
    const gitalk = new Gitalk({
        clientID: 'd526317e8c13bd9e1344',
        clientSecret: '3f2e043a8a04f4babf9e5d0804fd8e14f1b8d75d',
        repo: 'blog-comments',
        owner: 'hudingyu',
        admin: ['hudingyu'],
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
  </script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '140353961df3b8b3911818d8a175b712';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<!-- <img src="https://turling.me/img/icon_wechat.png" width="0" height="0" /> -->
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
